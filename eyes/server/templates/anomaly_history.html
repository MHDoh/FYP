{% extends "base.html" %}

{% block title %}Anomaly History - Karel Electronics{% endblock %}

{% block page_title %}Anomaly History{% endblock %}

{% block content %}
<div class="anomaly-history-view">
    <div class="toolbar" style="margin-bottom: 20px;">
        <!-- Filtering options will go here -->
        <div class="form-group">
            <label for="anomalyTypeFilter">Filter by Type:</label>
            <select id="anomalyTypeFilter" class="form-control">
                <option value="all" selected>All Types</option>
                <!-- Populate with anomaly types dynamically or statically -->
                <option value="crowd">Crowd Detected</option>
                <option value="labcoat">Lab Coat Violation</option>
                <option value="door">Door Ajar</option>
                <option value="light">Tower Light Issue</option>
                <option value="sensor">Sensor Threshold</option>
            </select>
        </div>
        <div class="form-group">
            <label for="dateRangeFilter">Date Range:</label>
            <input type="text" id="dateRangeFilter" class="form-control" placeholder="Select date range">
            <!-- Consider using a date range picker library -->
        </div>
        <button class="btn btn-primary">Apply Filters</button>
    </div>

    <div class="anomaly-list">
        <!-- Anomalies will be listed here, possibly in a table or a list of cards -->
        {% if anomalies %}
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Timestamp</th>
                        <th>Device ID</th>
                        <th>Channel</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for anomaly in anomalies %}
                    <tr>
                        <td>{{ anomaly.timestamp | format_datetime }}</td>
                        <td>{{ anomaly.device_id }}</td>
                        <td>{{ anomaly.channel_id | default('N/A') }}</td>
                        <td>{{ anomaly.type | title }}</td>
                        <td>{{ anomaly.description }}</td>
                        <td><a href="#" class="btn btn-sm btn-info view-anomaly-details" data-id="{{ anomaly.id }}">Details</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No anomalies recorded yet, or none match the current filters.</p>
        {% endif %}
    </div>
</div>

<!-- Placeholder for a modal to show detailed anomaly information -->
<div class="modal fade" id="anomalyDetailsModal" tabindex="-1" role="dialog" aria-labelledby="anomalyDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="anomalyDetailsModalLabel">Anomaly Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Detailed content will be loaded here via JavaScript -->
                <p>Loading details...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Placeholder for JavaScript to handle filtering, details modal, etc.
    console.log("Anomaly History page loaded.");

    // Example: Initialize a date range picker if you use one
    // $('#dateRangeFilter').daterangepicker(); 

    $('.view-anomaly-details').on('click', function(e) {
        e.preventDefault();
        const anomalyId = $(this).data('id');
        // In a real application, you would fetch details via AJAX
        // For now, just showing a placeholder in the modal
        $('#anomalyDetailsModal .modal-body').html(`
            <p><strong>Anomaly ID:</strong> ${anomalyId}</p>
            <p><strong>Timestamp:</strong> ${$(this).closest('tr').find('td:nth-child(1)').text()}</p>
            <p><strong>Device:</strong> ${$(this).closest('tr').find('td:nth-child(2)').text()}</p>
            <p><strong>Type:</strong> ${$(this).closest('tr').find('td:nth-child(4)').text()}</p>
            <p><strong>Description:</strong> ${$(this).closest('tr').find('td:nth-child(5)').text()}</p>
            <p><em>Further details and sensor readings would be loaded here.</em></p>
        `);
        $('#anomalyDetailsModal').modal('show');
    });
});
</script>
{% endblock %}
